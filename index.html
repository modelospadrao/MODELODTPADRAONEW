<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DT - Filtro, Ordena√ß√£o e WhatsApp</title>

<style>
    body { 
        font-family: Arial, sans-serif; 
        background: #eef1f5; 
        padding: 20px;
        margin: 0;
    }
    h2 { margin-bottom: 10px; }

    /* Container fixo para cabe√ßalho e filtros */
    .header-container {
        position: sticky;
        top: 0;
        background: #eef1f5;
        z-index: 100;
        padding-bottom: 10px;
    }

    /* Layout dos filtros em cascata */
    .filtros-cascata {
        display: flex;
        gap: 10px;
        flex-direction: row;
        justify-content: flex-start;
        align-items: stretch;
    }

    /* Wrapper da tabela com scroll */
    .table-wrapper {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
        overflow-x: auto;
        border: 2px solid #333;
        border-radius: 8px;
        background: white;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #004c97;
    }

    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ccc;
        font-size: 14px;
        white-space: nowrap;
    }

    th {
        background: #004c97;
        color: white;
        cursor: pointer;
        user-select: none;
    }

    th.selected {
        background: #0076d6 !important;
    }

    tr:hover { background: #f5faff; }

    .upload-box, .filtro-box {
        background: white;
        padding: 12px;
        width: 360px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
    }

    button {
        font-size: 16px;
        background-color: #444;
        color: #fff;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        padding: 10px 20px;
        box-shadow: 0 10px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    button:active {
        transform: scale(0.98);
    }

    button.gerado {
        background-color: green !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
    }

    button.realizado {
        background-color: green !important;
    }

    button.nao-realizado {
        background-color: red !important;
    }

    button.reset-btn {
        margin: 3px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }


    tr.marcado {
        background: #fff0f0 !important;
    }

    input.codigo, input.lead, input.retorno {
        width: 120px;
        margin: 3px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    input.obs, input.retorno {
        width: 30px;
        margin: 3px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }


    .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(0,0,0,0.95);
        color: #fff;
        font-size: 14px;
        border-radius: 12px;
        z-index: 10000;
        box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        text-align: center;
        max-width: 90%;
        min-width: 400px;
    }

    .popup textarea {
        width: 90%;
        min-height: 100px;
        padding: 9px;
        margin: 10px 0;
        border-radius: 8px;
        border: 2px solid #666;
        background: #222;
        color: #fff;
        font-size: 14px;
        resize: vertical;
    }

    .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .popup-buttons button {
        padding: 10px 25px;
        font-size: 13px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-weight: bold;
    }

    .popup .yes-button {
        background: #4CAF50;
        color: #fff;
    }

    .popup .no-button {
        background: #f44336;
        color: #fff;
    }

    .popup .close-button {
        background: #666;
        color: #fff;
        margin-top: 10px;
    }

    .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
    }

    .acoes-sessao {
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 25px;
        border: 3px solid #333;
        box-shadow: 7px 6px 5px rgba(0,0,0,0.3);
        text-align: center;
    }

    .acoes-sessao button {
        margin: 3px;
        padding: 8px 15px;
        font-size: 14px;
    }

    .btn-exportar {
        margin: 2px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-importar {
        margin: 2px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-limpar-filtros {
        margin: 2px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }


    .btn-limpar-tudo {
        background-color: red !important;
    }

    .btn-criar-rota {
        margin: 2px;
        padding: 6px 10px;
        border: none;
        background-color: rgb(250, 185, 0);
        color: #000000;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }


    /* GR√ÅFICO DE CONTAGEM - SEM CAIXA, COMPACTO √Ä DIREITA */
    .grafico-container {
        flex: 0 0 auto;
        background: transparent;
        padding: 0;
        margin-left: auto;
        border-radius: 0;
        border: none;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        min-width: 0;
        max-width: 600px;
    }

    .grafico-titulo {
        display: none;
    }

    .grafico-metricas {
        display: flex;
        flex-wrap: nowrap;
        flex-direction: row-reverse;
        gap: 6px;
        height: 100%;
        align-items: flex-end;
        justify-content: flex-end;
    }

    .metrica-item {
        flex: 0 0 auto;
        min-width: 55px;
        max-width: 75px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        padding: 4px;
        border-radius: 6px;
        background: #f8f9fa;
        position: relative;
    }

    .metrica-numero {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 3px;
        z-index: 2;
    }

    .metrica-barra {
        width: 100%;
        max-width: 40px;
        border-radius: 6px 6px 0 0;
        margin-bottom: 3px;
        transition: height 0.3s ease;
        min-height: 18px;
    }

    .metrica-label {
        font-size: 9px;
        color: #666;
        text-align: center;
        line-height: 1.1;
        z-index: 2;
    }

    /* Cores das barras */
    .metrica-total .metrica-barra { background: #2196F3; }
    .metrica-pendente .metrica-barra { background: #FF9800; }
    .metrica-criada .metrica-barra { background: #4CAF50; }
    .metrica-realizado .metrica-barra { background: #2E7D32; }
    .metrica-nao-realizado .metrica-barra { background: #f44336; }
    .metrica-reprogramar .metrica-barra { background: #9E9E9E; }
    .metrica-inspetor .metrica-barra { background: #263238; }

    /* Cores dos n√∫meros */
    .metrica-total .metrica-numero { color: #2196F3; }
    .metrica-pendente .metrica-numero { color: #FF9800; }
    .metrica-criada .metrica-numero { color: #4CAF50; }
    .metrica-realizado .metrica-numero { color: #2E7D32; }
    .metrica-nao-realizado .metrica-numero { color: #f44336; }
    .metrica-reprogramar .metrica-numero { color: #9E9E9E; }
    .metrica-inspetor .metrica-numero { color: #263238; }


    .status-salvamento {
        display: inline-block;
        margin-left: 10px;
        color: #28a745;
        font-size: 12px;
    }

    /* FILTROS EM BOT√ïES (BASE / SE / ALIM) */
    #botoesBASE,
    #botoesSE,
    #botoesALIM {
        background: #ffffff;
        padding: 8px;
        border-radius: 20px;
        border: 3px solid #333;
        box-shadow: 7px 6px 5px rgba(0,0,0,0.3);
        text-align: center;
        min-width: 200px;
        max-width: 400px;
        flex: 1;
        position: relative;
        min-height: 120px;
        display: flex;
        flex-direction: column;
    }

    #botoesBASE b,
    #botoesSE b,
    #botoesALIM b {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
    }

    #botoesBASE > br,
    #botoesSE > br,
    #botoesALIM > br {
        display: none;
    }

    .botoes-container {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
        align-content: flex-start;
        justify-content: center;
        padding-top: 25px;
    }

    /* Bot√µes padr√£o */
    #botoesBASE button,
    #botoesSE button,
    #botoesALIM button {
        margin: 3px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 12px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    /* Hover */
    #botoesBASE button:hover,
    #botoesSE button:hover,
    #botoesALIM button:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    /* Click */
    #botoesBASE button:active,
    #botoesSE button:active,
    #botoesALIM button:active {
        transform: scale(0.98);
    }

    /* Bot√£o ativo */
    #botoesBASE button.ativo,
    #botoesSE button.ativo,
    #botoesALIM button.ativo {
        background-color: #ffffff !important;
        color: red !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
        font-weight: bold;
    }

    /* Bot√£o limpar */
    #botoesBASE button.limpar,
    #botoesSE button.limpar,
    #botoesALIM button.limpar {
        background-color: #ff8c00 !important;
        color: #000 !important;
        font-weight: bold;
        position: absolute;
        top: 5px;
        left: 5px;
        padding: 4px 10px;
        font-size: 11px;
        border-radius: 12px 12px 0 0;
        margin: 0;
    }
     .container-botoes-menu {
    display: flex;
    justify-content: right; /* centraliza os bot√µes */
    align-items: center;
    }

    .input-file {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* ESCONDE o input feio */
    .input-file input[type="file"] {
        display: none;
    }

    .btn-file-input {
        padding: 8px 18px;
        background: linear-gradient(135deg, #444, #222);
        color: #fff;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        transition: all 0.25s ease;
    }

    .btn-file-input:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #555, #333);
    }

    .file-name {
        font-size: 13px;
        color: #ccc;
        font-style: italic;
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

</style>
</head>
<body>

<h2 style="text-align: center; font-size: 25px; font-weight: bold; color: #e63946;">MODELO CRIAR DT INSPE√á√ïES REINTERADAS E RNT</h2>
  <h2 style="text-align: center; font-size: 21px; font-weight: bold; color: #000;">(Vers√£o 5.0)</h2>

<div class="input-file">
    <label for="arquivoXLSX" class="btn-file-input">
        üìÇ Abrir arquivo
    </label>
    <span class="file-name" id="nomeArquivo">Nenhum arquivo selecionado</span>

    <input type="file" id="arquivoXLSX" accept=".xlsx" onchange="mostrarNomeArquivo(this)">
</div>

   
<div class="container-botoes-menu">    
    <button class="btn-exportar" onclick="exportarSessao()">üì• Exportar</button>
        <button class="btn-importar" onclick="document.getElementById('importarSessao').click()">üì§ Importar</button>
        <button class="btn-limpar-filtros" onclick="limparFiltros()">üîÑ Limpar Filtros</button>
        <button class="btn-criar-rota" id="btnCriarRota" onclick="criarRotaMapa()" style="display:none;">üó∫Ô∏è Criar Rota no Mapa</button>
        <input type="file" id="importarSessao" accept=".json" style="display:none;" onchange="importarSessao(this)">
        <span class="status-salvamento" id="statusSalvamento"></span>
</div>


   
    
<div id="popupOverlay" class="popup-overlay" onclick="fecharPopup()"></div>
<div id="popupTexto" class="popup">
    <h3 id="popupTitulo">Editar Texto</h3>
    <textarea id="popupTextarea"></textarea>
    <div class="popup-buttons">
        <button class="yes-button" onclick="salvarPopup()">‚úî Salvar</button>
        <button class="close-button" onclick="fecharPopup()">‚úñ Fechar</button>
    </div>
</div>

<div class="header-container">
    <div class="area-filtros-metricas">
    <div class="filtros-cascata">
        <div id="botoesBASE">
            <b>BASE:</b>
        </div>

        <div id="botoesSE" style="display:none;">
            <b>SE:</b>
        </div>

        <div id="botoesALIM" style="display:none;">
            <b>Alimentador:</b>
        </div>
    </div>

    <!-- GR√ÅFICO DE CONTAGEM -->
    <div class="grafico-container">
        <div class="grafico-metricas">
            <div class="metrica-item metrica-total">
                <span class="metrica-numero" id="metricaTotal">0</span>
                <div class="metrica-barra" style="height: 80px;"></div>
                <span class="metrica-label">Total<br>Filtrado</span>
            </div>
            <div class="metrica-item metrica-pendente">
                <span class="metrica-numero" id="metricaPendente">0</span>
                <div class="metrica-barra" style="height: 45px;"></div>
                <span class="metrica-label">Pendentes</span>
            </div>
            <div class="metrica-item metrica-criada">
                <span class="metrica-numero" id="metricaCriada">0</span>
                <div class="metrica-barra" style="height: 65px;"></div>
                <span class="metrica-label">DTs<br>Criadas</span>
            </div>
            <div class="metrica-item metrica-realizado">
                <span class="metrica-numero" id="metricaRealizado">0</span>
                <div class="metrica-barra" style="height: 55px;"></div>
                <span class="metrica-label">Realizados</span>
            </div>
            <div class="metrica-item metrica-nao-realizado">
                <span class="metrica-numero" id="metricaNaoRealizado">0</span>
                <div class="metrica-barra" style="height: 30px;"></div>
                <span class="metrica-label">N√£o<br>Realizados</span>
            </div>
            <div class="metrica-item metrica-reprogramar">
                <span class="metrica-numero" id="metricaReprogramar">0</span>
                <div class="metrica-barra" style="height: 25px;"></div>
                <span class="metrica-label">Reprogramar</span>
            </div>
            <div class="metrica-item metrica-inspetor">
                <span class="metrica-numero" id="metricaInspetor">0</span>
                <div class="metrica-barra" style="height: 18px;"></div>
                <span class="metrica-label">Enviar<br>Inspetor</span>
            </div>
        </div>
    </div>
</div>

<div class="table-wrapper">
    <table id="tabelaDT">
        <thead>
            <tr>
                <th onclick="ordenarTabela(0, this)">Ranking</th>
                <th onclick="ordenarTabela(1, this)">Tipo</th>
                <th onclick="ordenarTabela(2, this)">Equipamento</th>
                <th onclick="ordenarTabela(3, this)">Reiteradas</th>
                <th onclick="ordenarTabela(4, this)">SE</th>
                <th onclick="ordenarTabela(5, this)">Alimentador</th>
                <th onclick="ordenarTabela(6, this)">Base</th>
                <th onclick="ordenarTabela(7, this)">CHI</th>
                <th onclick="ordenarTabela(8, this)">Data</th>
                <th onclick="ordenarTabela(9, this)">Endere√ßo</th>
                <th onclick="ordenarTabela(10, this)">DT / Inc</th>
                <th onclick="ordenarTabela(11, this)">Observa√ß√£o</th>
                <th onclick="ordenarTabela(12, this)">Lead da Equipe</th>
                <th onclick="ordenarTabela(13, this)">Retorno</th>
                <th onclick="ordenarTabela(14, this)">A√ß√£o</th>
                <th onclick="ordenarTabela(15, this)">Status</th>
                <th>Reset</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// VARI√ÅVEIS GLOBAIS
let ultimoTH = null;
let lastSortedCol = null;
let lastOrderAsc = null;
let dadosOriginais = [];
let baseSelecionada = null;
let seSelecionado = null;
let alimentadorSelecionado = null;
let inputAtualPopup = null;

// FUN√á√ïES POPUP
function abrirPopup(input, titulo) {
    inputAtualPopup = input;
    document.getElementById('popupTitulo').innerText = titulo;
    document.getElementById('popupTextarea').value = input.value || '';
    document.getElementById('popupOverlay').style.display = 'block';
    document.getElementById('popupTexto').style.display = 'block';
    document.getElementById('popupTextarea').focus();
}

function fecharPopup() {
    document.getElementById('popupOverlay').style.display = 'none';
    document.getElementById('popupTexto').style.display = 'none';
    inputAtualPopup = null;
}

function salvarPopup() {
    if (inputAtualPopup) {
        inputAtualPopup.value = document.getElementById('popupTextarea').value;
        salvarSessaoAutomatica();
    }
    fecharPopup();
}

// AUTO-SAVE
function salvarSessaoAutomatica() {
    const sessao = capturarEstadoSessao();
    localStorage.setItem('dt_sessao_atual', JSON.stringify(sessao));
    
    const status = document.getElementById('statusSalvamento');
    status.textContent = '‚úî Salvo automaticamente';
    setTimeout(() => status.textContent = '', 2000);
}

// CAPTURAR ESTADO DA SESS√ÉO
function capturarEstadoSessao() {
    const linhas = Array.from(document.querySelectorAll("#tabelaDT tbody tr"));
    const dadosLinhas = linhas.map(linha => {
    const cols = linha.children;
    
    let enderecoOriginal = cols[9].getAttribute('data-endereco') || cols[9].innerText;
    
     return {
        dados: Array.from(cols).slice(0, 9).map(td => td.innerText),
        endereco: enderecoOriginal,
        codigo: cols[10].querySelector('input')?.value || '',
        obs: cols[11].querySelector('input')?.value || '',
        lead: cols[12].querySelector('input')?.value || '',
        retorno: cols[13].querySelector('input')?.value || '',
        marcado: linha.classList.contains('marcado'),
        gerado: cols[14].querySelector('button')?.classList.contains('gerado') || false,
        statusClasse: cols[15].querySelector('button')?.className || 'nao-realizado',  // ‚Üê ADICIONE
        statusTexto: cols[15].querySelector('button')?.innerText || 'N√£o Realizado'    // ‚Üê ADICIONE
       };
   });

    return {
        timestamp: new Date().toISOString(),
        dadosOriginais: dadosOriginais,
        dadosLinhas: dadosLinhas,
        filtros: {
            base: baseSelecionada,
            se: seSelecionado,
            alimentador: alimentadorSelecionado
        }
    };
}

// EXPORTAR SESS√ÉO
function exportarSessao() {
    const sessao = capturarEstadoSessao();
    const blob = new Blob([JSON.stringify(sessao, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sessao_dt_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Sess√£o exportada com sucesso!');
}

// IMPORTAR SESS√ÉO
function importarSessao(input) {
    const arquivo = input.files[0];
    if (!arquivo) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const sessao = JSON.parse(e.target.result);
            restaurarSessao(sessao);
            alert('‚úÖ Sess√£o importada com sucesso!');
        } catch (erro) {
            alert('‚ùå Erro ao importar sess√£o: ' + erro.message);
        }
    };
    reader.readAsText(arquivo);
    input.value = '';
}

// RESTAURAR SESS√ÉO
function restaurarSessao(sessao) {
    dadosOriginais = sessao.dadosOriginais || [];
    
    const tbody = document.querySelector("#tabelaDT tbody");
    tbody.innerHTML = "";

    sessao.dadosLinhas.forEach(item => {
        const tr = document.createElement("tr");
        
        let htmlColunas = '';
        item.dados.forEach((dado) => {
            htmlColunas += `<td>${dado}</td>`;
        });
        
        let enderecoOriginal = item.endereco || "";
        let enderecoHTML = enderecoOriginal;
        if (enderecoOriginal && enderecoOriginal.includes(",")) {
            let coords = enderecoOriginal.split(",");
            if (coords.length === 2) {
                let lat = coords[0].trim();
                let lng = coords[1].trim();
                enderecoHTML = `<button onclick="window.open('https://www.google.com/maps?q=${lat},${lng}', '_blank')">üó∫Ô∏è Mapa</button>`;
            }
        }

        const botaoTexto = item.gerado ? 'DT Criada' : 'Criar DT';
        const statusTexto = item.statusTexto || 'N√£o Realizado';
        const statusClasse = item.statusClasse || 'nao-realizado';

        const codigoVal = (item.codigo && item.codigo !== 'undefined') ? item.codigo : '';
        const obsVal = (item.obs && item.obs !== 'undefined') ? item.obs : '';
        const leadVal = (item.lead && item.lead !== 'undefined') ? item.lead : '';
        const retornoVal = (item.retorno && item.retorno !== 'undefined') ? item.retorno : '';

        tr.innerHTML = htmlColunas + `
            <td data-endereco="${enderecoOriginal}">${enderecoHTML}</td>
            <td><input maxlength="10" class="codigo" placeholder="Ex: INSERIR" value="${codigoVal}" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="obs" placeholder="..." value="${obsVal}" readonly onclick="abrirPopup(this, 'Observa√ß√£o')"></td>
            <td><input class="lead" placeholder="" value="${leadVal}" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="retorno" placeholder="..." value="${retornoVal}" readonly onclick="abrirPopup(this, 'Retorno')"></td>
            <td><button onclick="gerarMensagem(this)" ${item.gerado ? 'class="gerado"' : ''}>${botaoTexto}</button></td>
            <td><button class="${statusClasse}" onclick="toggleStatus(this)">${statusTexto}</button></td>
            <td><button class="reset-btn" onclick="resetarLinha(this)">‚Ü∫</button></td>
        `;

        if (item.marcado) tr.classList.add('marcado');
        tbody.appendChild(tr);
    });

    baseSelecionada = sessao.filtros.base;
    seSelecionado = sessao.filtros.se;
    alimentadorSelecionado = sessao.filtros.alimentador;
    
    atualizarBotoesBASE();
    aplicarFiltros();
    verificarBotaoRota();
}

// CARREGAR SESS√ÉO AO ABRIR
window.addEventListener('DOMContentLoaded', function() {
    const sessaoSalva = localStorage.getItem('dt_sessao_atual');
    if (sessaoSalva) {
        try {
            const sessao = JSON.parse(sessaoSalva);
            restaurarSessao(sessao);
            console.log('‚úÖ Sess√£o anterior restaurada automaticamente');
        } catch (erro) {
            console.error('Erro ao restaurar sess√£o:', erro);
        }
    }
});

// LIMPAR APENAS OS FILTROS
function limparFiltros() {
    baseSelecionada = null;
    seSelecionado = null;
    alimentadorSelecionado = null;
    
    atualizarBotoesBASE();
    aplicarFiltros();
    
    const status = document.getElementById('statusSalvamento');
    status.textContent = '‚úî Filtros limpos!';
    status.style.color = '#667eea';
    setTimeout(() => status.textContent = '', 2000);
}

// RESETAR LINHA
function resetarLinha(botaoReset) {
    const linha = botaoReset.parentNode.parentNode;
    const botaoGerar = linha.querySelector('td:nth-child(15) button');
    const botaoStatus = linha.querySelector('td:nth-child(16) button');
    
    linha.classList.remove('marcado');
    botaoGerar.classList.remove('gerado');
    botaoGerar.innerText = 'Criar DT';
    
    botaoStatus.classList.remove('realizado');
    botaoStatus.classList.add('nao-realizado');
    botaoStatus.innerText = 'N√£o Realizado';
    
    salvarSessaoAutomatica();
    atualizarGrafico();
}

// TOGGLE STATUS (4 ESTADOS ROTATIVOS)
function toggleStatus(botao) {
    // Estados: N√£o Realizado ‚Üí Realizado ‚Üí Reprogramar ‚Üí Enviar Inspetor ‚Üí N√£o Realizado
    if (botao.classList.contains('nao-realizado')) {
        botao.classList.remove('nao-realizado');
        botao.classList.add('realizado');
        botao.innerText = 'Realizado';
    } else if (botao.classList.contains('realizado')) {
        botao.classList.remove('realizado');
        botao.classList.add('reprogramar');
        botao.innerText = 'Reprogramar';
    } else if (botao.classList.contains('reprogramar')) {
        botao.classList.remove('reprogramar');
        botao.classList.add('enviar-inspetor');
        botao.innerText = 'Enviar Inspetor';
    } else if (botao.classList.contains('enviar-inspetor')) {
        botao.classList.remove('enviar-inspetor');
        botao.classList.add('nao-realizado');
        botao.innerText = 'N√£o Realizado';
    }
    salvarSessaoAutomatica();
    verificarBotaoRota();
    atualizarGrafico();
}


// ATUALIZAR GR√ÅFICO
function atualizarGrafico() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");
    
    let total = 0;
    let pendente = 0;
    let criada = 0;
    let realizado = 0;
    let naoRealizado = 0;
    let reprogramar = 0;
    let inspetor = 0;

    linhas.forEach(linha => {
        if (linha.style.display !== "none") {
            total++;
            
            const botaoAcao = linha.querySelector('td:nth-child(15) button');
            if (botaoAcao) {
                if (botaoAcao.classList.contains('gerado')) {
                    criada++;
                } else {
                    pendente++;
                }
            }
            
            const botaoStatus = linha.querySelector('td:nth-child(16) button');
            if (botaoStatus) {
                if (botaoStatus.classList.contains('realizado')) {
                    realizado++;
                } else if (botaoStatus.classList.contains('reprogramar')) {
                    reprogramar++;
                } else if (botaoStatus.classList.contains('enviar-inspetor')) {
                    inspetor++;
                } else {
                    naoRealizado++;
                }
            }
        }
    });

    document.getElementById('metricaTotal').textContent = total;
    document.getElementById('metricaPendente').textContent = pendente;
    document.getElementById('metricaCriada').textContent = criada;
    document.getElementById('metricaRealizado').textContent = realizado;
    document.getElementById('metricaNaoRealizado').textContent = naoRealizado;
    document.getElementById('metricaReprogramar').textContent = reprogramar;
    document.getElementById('metricaInspetor').textContent = inspetor;
}

// Destacar TH selecionado
function destacarTH(th) {
    if (ultimoTH) ultimoTH.classList.remove("selected");
    if (th) th.classList.add("selected");
    ultimoTH = th;
}

// Converter data serial do Excel
function formatarData(valor) {
    if (!valor) return "";
    
    if (typeof valor === 'string' && valor.includes('/')) {
        return valor;
    }
    
    if (typeof valor === 'number') {
        const dataExcel = new Date((valor - 25569) * 86400 * 1000);
        const dia = String(dataExcel.getDate()).padStart(2, '0');
        const mes = String(dataExcel.getMonth() + 1).padStart(2, '0');
        const ano = dataExcel.getFullYear();
        return `${dia}/${mes}/${ano}`;
    }
    
    try {
        const data = new Date(valor);
        if (!isNaN(data.getTime())) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }
    } catch (e) {
        return valor;
    }
    
    return valor;
}

// APLICAR FILTROS
function aplicarFiltros() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");

    linhas.forEach(linha => {
        const base = (linha.children[6].innerText || "").trim();
        const se = (linha.children[4].innerText || "").trim();
        const alim = (linha.children[5].innerText || "").trim();

        const condBase = !baseSelecionada || base === baseSelecionada;
        const condSE = !seSelecionado || se === seSelecionado;
        const condAlim = !alimentadorSelecionado || alim === alimentadorSelecionado;

        linha.style.display = (condBase && condSE && condAlim) ? "" : "none";
    });

    verificarBotaoRota();
    atualizarGrafico();
}

// VERIFICAR SE DEVE MOSTRAR BOT√ÉO DE ROTA
function verificarBotaoRota() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let temDTCriada = false;

    linhas.forEach(linha => {
        if (linha.style.display !== "none") {
            const botaoAcao = linha.querySelector('td:nth-child(15) button');
            if (botaoAcao && botaoAcao.classList.contains('gerado')) {
                temDTCriada = true;
            }
        }
    });

    const btnRota = document.getElementById('btnCriarRota');
    btnRota.style.display = temDTCriada ? 'inline-block' : 'none';
}

// CRIAR ROTA NO MAPA
function criarRotaMapa() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");
    const coordenadas = [];

    linhas.forEach(linha => {
        if (linha.style.display !== "none") {
            const botaoAcao = linha.querySelector('td:nth-child(15) button');
            if (botaoAcao && botaoAcao.classList.contains('gerado')) {
                const enderecoTD = linha.querySelector('td:nth-child(10)');
                const endereco = enderecoTD.getAttribute('data-endereco');
                
                if (endereco && endereco.includes(',')) {
                    coordenadas.push({
                        coordenada: endereco.trim(),
                        equipamento: linha.children[2].innerText,
                        ranking: linha.children[0].innerText
                    });
                }
            }
        }
    });

    if (coordenadas.length === 0) {
        alert('‚ùå Nenhum item com "DT Criada" encontrado no filtro atual!');
        return;
    }

    if (coordenadas.length === 1) {
        // Se s√≥ tem 1 ponto, abre direto
        window.open(`https://www.google.com/maps?q=${coordenadas[0].coordenada}`, '_blank');
        return;
    }

    // Monta URL da rota no Google Maps
    // Origem: primeiro ponto
    const origem = coordenadas[0].coordenada;
    
    // Destino: √∫ltimo ponto
    const destino = coordenadas[coordenadas.length - 1].coordenada;
    
    // Waypoints: pontos intermedi√°rios (m√°ximo 9 waypoints no Google Maps)
    let waypoints = [];
    for (let i = 1; i < coordenadas.length - 1 && waypoints.length < 9; i++) {
        waypoints.push(coordenadas[i].coordenada);
    }

    let url = `https://www.google.com/maps/dir/?api=1&origin=${origem}&destination=${destino}`;
    
    if (waypoints.length > 0) {
        url += `&waypoints=${waypoints.join('|')}`;
    }

    url += '&travelmode=driving';

    // Mostra resumo
    const resumo = `
üó∫Ô∏è ROTA CRIADA COM SUCESSO!

üìç Total de pontos: ${coordenadas.length}
${coordenadas.length > 11 ? '\n‚ö†Ô∏è Aten√ß√£o: Google Maps limita a 10 paradas intermedi√°rias.\nApenas os primeiros 11 pontos ser√£o inclu√≠dos na rota.' : ''}

üöó Abrindo rota no Google Maps...

Lista de equipamentos na rota:
${coordenadas.slice(0, 11).map((c, i) => `${i + 1}. ${c.equipamento} (Ranking: ${c.ranking})`).join('\n')}
    `.trim();

    alert(resumo);
    window.open(url, '_blank');
}

// ATUALIZAR BOT√ïES BASE
function atualizarBotoesBASE() {
    let divBASE = document.getElementById("botoesBASE");
    let divSE = document.getElementById("botoesSE");
    let divALIM = document.getElementById("botoesALIM");
    
    divBASE.innerHTML = "<b>BASE:</b>";
    
    let containerBotoes = document.createElement('div');
    containerBotoes.className = 'botoes-container';
    
    if (baseSelecionada) {
        let btnLimpar = document.createElement("button");
        btnLimpar.innerText = "‚úñ";
        btnLimpar.className = "limpar";
        btnLimpar.title = "Limpar BASE";
        btnLimpar.onclick = () => {
            baseSelecionada = null;
            seSelecionado = null;
            alimentadorSelecionado = null;
            atualizarBotoesBASE();
            aplicarFiltros();
            atualizarGrafico();
        };
        divBASE.appendChild(btnLimpar);
    }

    let linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let contagemBase = {};

    linhas.forEach(l => {
        let base = l.children[6].innerText.trim();
        if (base) contagemBase[base] = (contagemBase[base] || 0) + 1;
    });

    Object.keys(contagemBase).sort().forEach(base => {
        let btn = document.createElement("button");
        btn.innerText = `${base} (${contagemBase[base]})`;
        btn.onclick = () => {
            baseSelecionada = base;
            seSelecionado = null;
            alimentadorSelecionado = null;
            atualizarBotoesBASE();
            atualizarBotoesSE();
            aplicarFiltros();
        };
        if (baseSelecionada === base) btn.classList.add('ativo');
        containerBotoes.appendChild(btn);
    });

    divBASE.appendChild(containerBotoes);

    if (baseSelecionada) {
        divSE.style.display = 'flex';
        atualizarBotoesSE();
    } else {
        divSE.style.display = 'none';
        divALIM.style.display = 'none';
    }
}

// ATUALIZAR BOT√ïES SE
function atualizarBotoesSE() {
    let divSE = document.getElementById("botoesSE");
    let divALIM = document.getElementById("botoesALIM");
    
    divSE.innerHTML = "<b>SE:</b>";
    
    let containerBotoes = document.createElement('div');
    containerBotoes.className = 'botoes-container';
    
    if (seSelecionado) {
        let btnLimpar = document.createElement("button");
        btnLimpar.innerText = "‚úñ";
        btnLimpar.className = "limpar";
        btnLimpar.title = "Limpar SE";
        btnLimpar.onclick = () => {
            seSelecionado = null;
            alimentadorSelecionado = null;
            atualizarBotoesSE();
            aplicarFiltros();
        };
        divSE.appendChild(btnLimpar);
    }

    let linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let contagemSE = {};

    linhas.forEach(l => {
        let base = l.children[6].innerText.trim();
        let se = l.children[4].innerText.trim();
        if (base === baseSelecionada && se) {
            contagemSE[se] = (contagemSE[se] || 0) + 1;
        }
    });

    Object.keys(contagemSE).sort().forEach(se => {
        let btn = document.createElement("button");
        btn.innerText = `${se} (${contagemSE[se]})`;
        btn.onclick = () => {
            seSelecionado = se;
            alimentadorSelecionado = null;
            atualizarBotoesSE();
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        if (seSelecionado === se) btn.classList.add('ativo');
        containerBotoes.appendChild(btn);
    });

    divSE.appendChild(containerBotoes);

    if (seSelecionado) {
        divALIM.style.display = 'flex';
        atualizarBotoesALIM();
    } else {
        divALIM.style.display = 'none';
    }
}

// ATUALIZAR BOT√ïES ALIMENTADOR
function atualizarBotoesALIM() {
    let divALIM = document.getElementById("botoesALIM");
    divALIM.innerHTML = "<b>Alimentador:</b>";
    
    let containerBotoes = document.createElement('div');
    containerBotoes.className = 'botoes-container';
    
    if (alimentadorSelecionado) {
        let btnLimpar = document.createElement("button");
        btnLimpar.innerText = "‚úñ";
        btnLimpar.className = "limpar";
        btnLimpar.title = "Limpar Alimentador";
        btnLimpar.onclick = () => {
            alimentadorSelecionado = null;
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        divALIM.appendChild(btnLimpar);
    }

    let linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let contagemAlim = {};

    linhas.forEach(l => {
        let se = l.children[4].innerText.trim();
        let alim = l.children[5].innerText.trim();
        if (se === seSelecionado && alim) {
            contagemAlim[alim] = (contagemAlim[alim] || 0) + 1;
        }
    });

    Object.keys(contagemAlim).sort().forEach(alim => {
        let btn = document.createElement("button");
        btn.innerText = `${alim} (${contagemAlim[alim]})`;
        btn.onclick = () => {
            alimentadorSelecionado = alim;
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        if (alimentadorSelecionado === alim) btn.classList.add('ativo');
        containerBotoes.appendChild(btn);
    });

    divALIM.appendChild(containerBotoes);
}

// ORDENAR TABELA
function isNumericString(s) {
    if (!s) return false;
    const cleaned = String(s).trim().replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,'');
    if (cleaned === "") return false;
    return !isNaN(Number(cleaned));
}

function ordenarTabela(coluna, thElement) {
    destacarTH(thElement);

    const tbody = document.querySelector("#tabelaDT tbody");
    const todas = Array.from(tbody.querySelectorAll("tr"));
    const visiveis = todas.filter(r => r.style.display !== "none");

    const sample = visiveis.map(r => {
        let cell = r.children[coluna];
        let input = cell.querySelector('input');
        let btn = cell.querySelector('button');
        return input ? input.value.trim() : (btn ? btn.innerText.trim() : cell.innerText.trim());
    }).filter(v => v !== "");

    const numericCount = sample.filter(v => isNumericString(v)).length;
    const isNumeric = sample.length > 0 && numericCount >= Math.ceil(sample.length * 0.6);

    let orderAsc;
    if (lastSortedCol === coluna) {
        orderAsc = !lastOrderAsc;
    } else {
        orderAsc = !isNumeric;
    }

    visiveis.sort((a,b) => {
        let cellA = a.children[coluna];
        let cellB = b.children[coluna];
        
        let inputA = cellA.querySelector('input');
        let inputB = cellB.querySelector('input');
        let btnA = cellA.querySelector('button');
        let btnB = cellB.querySelector('button');
        
        let va = inputA ? inputA.value.trim() : (btnA ? btnA.innerText.trim() : cellA.innerText.trim());
        let vb = inputB ? inputB.value.trim() : (btnB ? btnB.innerText.trim() : cellB.innerText.trim());

        if (isNumeric && isNumericString(va) && isNumericString(vb)) {
            const na = Number(va.replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,''))||0;
            const nb = Number(vb.replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,''))||0;
            return orderAsc ? na - nb : nb - na;
        }

        return orderAsc ? va.localeCompare(vb,'pt') : vb.localeCompare(va,'pt');
    });

    lastSortedCol = coluna;
    lastOrderAsc = orderAsc;

    visiveis.forEach(r => tbody.appendChild(r));
}

// GERAR MENSAGEM
function gerarMensagem(botao) {
    let linha = botao.parentNode.parentNode;
    let col = linha.getElementsByTagName("td");

    let codigoInput = col[10].querySelector("input");
    let codigo = codigoInput ? codigoInput.value.toUpperCase() : "";

    let obsInput = col[11].querySelector("input");
    let obs = obsInput ? obsInput.value : "";

    let leadInput = col[12].querySelector("input");
    let lead = leadInput ? leadInput.value : "";

    let enderecoTD = col[9];
    let enderecoOriginal = enderecoTD.getAttribute('data-endereco') || "";
    
    let enderecoMensagem = enderecoOriginal;
    if (enderecoOriginal && enderecoOriginal.includes(",")) {
        let coords = enderecoOriginal.split(",");
        if (coords.length === 2) {
            enderecoMensagem = `https://www.google.com/maps?q=${coords[0].trim()},${coords[1].trim()}`;
        }
    }

    let msg =
`*MODELO PARA ATENDER DT*

*Ranking:* ${col[0].innerText}
*Tipo de equipamento:* ${col[1].innerText}
*Equipamento:* ${col[2].innerText}
*Reiteradas:* ${col[3].innerText}
*SE:* ${col[4].innerText}
*Alimentador:* ${col[5].innerText}
*Base:* ${col[6].innerText}
*CHI Total:* ${col[7].innerText}
*Data √∫ltima ocorr√™ncia:* ${col[8].innerText}
*Endere√ßo:* ${enderecoMensagem}
*DT / Incid√™ncia:* ${codigo}
*Observa√ß√£o:* ${obs}
*Lead da Equipe:* ${lead}`;

    navigator.clipboard.writeText(msg);

    linha.classList.add("marcado");
    botao.classList.add("gerado");
    botao.innerText = "DT Criada";
    
    salvarSessaoAutomatica();
    verificarBotaoRota();
    atualizarGrafico();
}

// CARREGAR XLSX
document.getElementById("arquivoXLSX").addEventListener("change", function(e) {
    let arquivo = e.target.files[0];
    let reader = new FileReader();

    reader.onload = function(event) {
        let data = new Uint8Array(event.target.result);
        let workbook = XLSX.read(data, {type: "array"});
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let json = XLSX.utils.sheet_to_json(sheet, {defval: ""});

        dadosOriginais = json;
        preencherTabela(json);
        salvarSessaoAutomatica();
    };

    reader.readAsArrayBuffer(arquivo);
});

// POPULAR TABELA
function preencherTabela(dados) {
    let tbody = document.querySelector("#tabelaDT tbody");
    tbody.innerHTML = "";

    dados.forEach(item => {
        let tr = document.createElement("tr");
        
        let enderecoOriginal = item.ENDERE√áO || "";
        let enderecoHTML = enderecoOriginal;
        
        if (enderecoOriginal && enderecoOriginal.includes(",")) {
            let coords = enderecoOriginal.split(",");
            if (coords.length === 2) {
                let lat = coords[0].trim();
                let lng = coords[1].trim();
                enderecoHTML = `<button onclick="window.open('https://www.google.com/maps?q=${lat},${lng}', '_blank')">üó∫Ô∏è Mapa</button>`;
            }
        }

        tr.innerHTML = `
            <td>${item.RANKING || ""}</td>
            <td>${item["TIPO DE EQUIPAMENTO"] || ""}</td>
            <td>${item.EQUIPAMENTO || ""}</td>
            <td>${item["QNTD. REITERADA"] || ""}</td>
            <td>${item.SE || ""}</td>
            <td>${item.ALIMENTADOR || ""}</td>
            <td>${item.BASE || ""}</td>
            <td>${item["CHI TOTAL"] || ""}</td>
            <td>${formatarData(item["DT. ULTIMA OCORR√äNCIA"] || "")}</td>
            <td data-endereco="${enderecoOriginal}">${enderecoHTML}</td>
            <td><input maxlength="10" class="codigo" placeholder="Ex: INSERIR" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="obs" placeholder="..." readonly onclick="abrirPopup(this, 'Observa√ß√£o')"></td>
            <td><input class="lead" placeholder="" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="retorno" placeholder="..." readonly onclick="abrirPopup(this, 'Retorno')"></td>
            <td><button onclick="gerarMensagem(this)">Criar DT</button></td>
            <td><button class="nao-realizado" onclick="toggleStatus(this)">N√£o Realizado</button></td>
            <td><button class="reset-btn" onclick="resetarLinha(this)">‚Ü∫</button></td>
        `;

        tbody.appendChild(tr);
    });

    atualizarBotoesBASE();
    aplicarFiltros();
}
</script>

</body>
</html>
