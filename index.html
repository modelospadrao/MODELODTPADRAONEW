<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DT - Filtro, OrdenaÃ§Ã£o e WhatsApp</title>

<style>
    body { font-family: Arial, sans-serif; background: #eef1f5; padding: 20px; }
    h2 { margin-bottom: 10px; }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        margin-top: 15px;
        border-radius: 6px;
        overflow: hidden;
    }

    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ccc;
        font-size: 14px;
    }

    th {
        background: #004c97;
        color: white;
        cursor: pointer;
        user-select: none;
    }

    th.selected {
        background: #0076d6 !important;
    }

    tr:hover { background: #f5faff; }

    .upload-box, .filtro-box {
        background: white;
        padding: 12px;
        width: 360px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
    }

    button {
        padding: 6px 12px;
        background: #008000;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    button.gerado {
        background: #cc0000 !important;
    }

    button.reset-btn {
        background: #ff8c00 !important;
        padding: 4px 8px;
        font-size: 12px;
    }

    tr.marcado {
        background: #fff0f0 !important;
    }

    input.codigo {
        width: 110px;
        text-transform: uppercase;
        font-weight: bold;
    }

    input.obs {
        width: 160px;
    }

    .caixa-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .caixa {
        background: white;
        padding: 12px;
        min-width: 260px;
        border-radius: 6px;
        border: 2px solid #aaa;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .caixa select,
    .caixa input {
        width: 100%;
    }

    #botoesSE {
        margin: 15px 0;
        padding: 10px;
        background: white;
        border-radius: 6px;
        border: 2px solid #aaa;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    #botoesSE button {
        margin: 3px;
        padding: 5px 10px;
        border: none;
        background: #004c97;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }

    #botoesSE button:hover {
        background: #0065cc;
    }

    .acoes-sessao {
        margin: 15px 0;
        padding: 12px;
        background: white;
        border-radius: 6px;
        border: 2px solid #28a745;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .acoes-sessao button {
        margin: 3px;
        padding: 6px 12px;
    }

    .btn-exportar {
        background: #28a745 !important;
    }

    .btn-importar {
        background: #17a2b8 !important;
    }

    .btn-limpar-filtros {
        background: #ffc107 !important;
        color: #000 !important;
    }

    .status-salvamento {
        display: inline-block;
        margin-left: 10px;
        color: #28a745;
        font-size: 12px;
    }
</style>
</head>
<body>

<h2>Lista de DT com Filtro + OrdenaÃ§Ã£o + WhatsApp</h2>

<div class="acoes-sessao">
    <b>ðŸ’¾ Gerenciar SessÃ£o:</b><br>
    <button class="btn-exportar" onclick="exportarSessao()">ðŸ“¥ Exportar SessÃ£o</button>
    <button class="btn-importar" onclick="document.getElementById('importarSessao').click()">ðŸ“¤ Importar SessÃ£o</button>
    <button class="btn-limpar-filtros" onclick="limparFiltros()">ðŸ”„ Limpar Filtros</button>
    <input type="file" id="importarSessao" accept=".json" style="display:none;" onchange="importarSessao(this)">
    <span class="status-salvamento" id="statusSalvamento"></span>
</div>

<div class="caixa-container">

    <div class="caixa">
        <b>Abrir planilha XLSX:</b><br>
        <input type="file" id="arquivoXLSX" accept=".xlsx">
    </div>

    <div class="caixa">
        <b>Filtrar pela BASE:</b><br>
        <select id="filtroBase">
            <option value="">Mostrar Todas</option>
        </select>
    </div>

    <div class="caixa">
        <b>Filtrar pelo ALIMENTADOR:</b><br>
        <select id="filtroAlim">
            <option value="">Mostrar Todos</option>
        </select>
    </div>

</div>

<div id="botoesSE"><b>Filtrar por SE:</b><br></div>

<table id="tabelaDT">
    <thead>
        <tr>
            <th onclick="ordenarTabela(0, this)">Ranking</th>
            <th onclick="ordenarTabela(1, this)">Tipo Equipamento</th>
            <th onclick="ordenarTabela(2, this)">Equipamento</th>
            <th onclick="ordenarTabela(3, this)">Reiteradas</th>
            <th onclick="ordenarTabela(4, this)">SE</th>
            <th onclick="ordenarTabela(5, this)">Alimentador</th>
            <th onclick="ordenarTabela(6, this)">Base</th>
            <th onclick="ordenarTabela(7, this)">CHI Total</th>
            <th onclick="ordenarTabela(8, this)">Data Ãšlt. OcorrÃªncia</th>
            <th onclick="ordenarTabela(9, this)">EndereÃ§o</th>
            <th onclick="ordenarTabela(10, this)">DT / IncidÃªncia</th>
            <th>ObservaÃ§Ã£o</th>
            <th>AÃ§Ã£o</th>
            <th>Reset</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ------------------------------
// VARIÃVEIS GLOBAIS
// ------------------------------
let ultimoTH = null;
let lastSortedCol = null;
let lastOrderAsc = null;
let dadosOriginais = []; // Armazena os dados da planilha

// ------------------------------
// AUTO-SAVE: Salvar automaticamente no localStorage
// ------------------------------
function salvarSessaoAutomatica() {
    const sessao = capturarEstadoSessao();
    localStorage.setItem('dt_sessao_atual', JSON.stringify(sessao));
    
    const status = document.getElementById('statusSalvamento');
    status.textContent = 'âœ“ Salvo automaticamente';
    setTimeout(() => status.textContent = '', 2000);
}

// ------------------------------
// CAPTURAR ESTADO DA SESSÃƒO
// ------------------------------
function capturarEstadoSessao() {
    const linhas = Array.from(document.querySelectorAll("#tabelaDT tbody tr"));
    const dadosLinhas = linhas.map(linha => {
        const cols = linha.children;
        return {
            dados: Array.from(cols).slice(0, 10).map(td => td.innerText),
            codigo: cols[10].querySelector('input')?.value || '',
            obs: cols[11].querySelector('input')?.value || '',
            marcado: linha.classList.contains('marcado'),
            gerado: cols[12].querySelector('button')?.classList.contains('gerado') || false
        };
    });

    return {
        timestamp: new Date().toISOString(),
        dadosOriginais: dadosOriginais,
        dadosLinhas: dadosLinhas,
        filtros: {
            base: document.getElementById('filtroBase').value,
            alimentador: document.getElementById('filtroAlim').value
        }
    };
}

// ------------------------------
// EXPORTAR SESSÃƒO (DOWNLOAD)
// ------------------------------
function exportarSessao() {
    const sessao = capturarEstadoSessao();
    const blob = new Blob([JSON.stringify(sessao, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sessao_dt_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('âœ… SessÃ£o exportada com sucesso!');
}

// ------------------------------
// IMPORTAR SESSÃƒO
// ------------------------------
function importarSessao(input) {
    const arquivo = input.files[0];
    if (!arquivo) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const sessao = JSON.parse(e.target.result);
            restaurarSessao(sessao);
            alert('âœ… SessÃ£o importada com sucesso!');
        } catch (erro) {
            alert('âŒ Erro ao importar sessÃ£o: ' + erro.message);
        }
    };
    reader.readAsText(arquivo);
    input.value = ''; // Limpa o input
}

// ------------------------------
// RESTAURAR SESSÃƒO
// ------------------------------
function restaurarSessao(sessao) {
    dadosOriginais = sessao.dadosOriginais || [];
    
    const tbody = document.querySelector("#tabelaDT tbody");
    tbody.innerHTML = "";

    sessao.dadosLinhas.forEach(item => {
        const tr = document.createElement("tr");
        
        let htmlColunas = '';
        item.dados.forEach((dado, idx) => {
            if (idx === 9) { // EndereÃ§o
                htmlColunas += `<td>${dado}</td>`;
            } else {
                htmlColunas += `<td>${dado}</td>`;
            }
        });

        tr.innerHTML = htmlColunas + `
            <td><input maxlength="10" class="codigo" placeholder="Ex: INSERIR" value="${item.codigo}"></td>
            <td><input class="obs" placeholder="Obs" value="${item.obs}"></td>
            <td><button onclick="gerarMensagem(this)" ${item.gerado ? 'class="gerado"' : ''}>Gerar Msg</button></td>
            <td><button class="reset-btn" onclick="resetarLinha(this)">â†º</button></td>
        `;

        if (item.marcado) tr.classList.add('marcado');
        tbody.appendChild(tr);
    });

    // Restaurar filtros
    preencherFiltros();
    document.getElementById('filtroBase').value = sessao.filtros.base || '';
    atualizarAlimentadoresPorBase();
    document.getElementById('filtroAlim').value = sessao.filtros.alimentador || '';
    
    aplicarFiltros();
    atualizarBotoesSE();
}

// ------------------------------
// CARREGAR SESSÃƒO AUTOMATICAMENTE AO ABRIR
// ------------------------------
window.addEventListener('DOMContentLoaded', function() {
    const sessaoSalva = localStorage.getItem('dt_sessao_atual');
    if (sessaoSalva) {
        try {
            const sessao = JSON.parse(sessaoSalva);
            restaurarSessao(sessao);
            console.log('âœ… SessÃ£o anterior restaurada automaticamente');
        } catch (erro) {
            console.error('Erro ao restaurar sessÃ£o:', erro);
        }
    }
});

// ------------------------------
// LIMPAR APENAS OS FILTROS
// ------------------------------
function limparFiltros() {
    document.getElementById('filtroBase').value = '';
    document.getElementById('filtroAlim').value = '';
    atualizarAlimentadoresPorBase();
    aplicarFiltros();
    alert('âœ… Filtros limpos!');
}

// ------------------------------
// RESETAR LINHA (desfaz marcaÃ§Ã£o)
// ------------------------------
function resetarLinha(botaoReset) {
    const linha = botaoReset.parentNode.parentNode;
    const botaoGerar = linha.querySelector('td:nth-child(13) button');
    
    linha.classList.remove('marcado');
    botaoGerar.classList.remove('gerado');
    
    salvarSessaoAutomatica();
}

// ------------------------------
// Destacar TH selecionado
// ------------------------------
function destacarTH(th) {
    if (ultimoTH) ultimoTH.classList.remove("selected");
    if (th) th.classList.add("selected");
    ultimoTH = th;
}

// ------------------------------
// Converter data serial do Excel para DD/MM/AAAA
// ------------------------------
function formatarData(valor) {
    if (!valor) return "";
    
    // Se jÃ¡ estÃ¡ em formato de texto (DD/MM/AAAA), retorna
    if (typeof valor === 'string' && valor.includes('/')) {
        return valor;
    }
    
    // Se Ã© nÃºmero serial do Excel
    if (typeof valor === 'number') {
        // Excel serializa datas como dias desde 30/12/1899
        const dataExcel = new Date((valor - 25569) * 86400 * 1000);
        const dia = String(dataExcel.getDate()).padStart(2, '0');
        const mes = String(dataExcel.getMonth() + 1).padStart(2, '0');
        const ano = dataExcel.getFullYear();
        return `${dia}/${mes}/${ano}`;
    }
    
    // Tenta converter outros formatos
    try {
        const data = new Date(valor);
        if (!isNaN(data.getTime())) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }
    } catch (e) {
        return valor;
    }
    
    return valor;
}

// ------------------------------
// FILTROS (BASE + ALIMENTADOR)
// ------------------------------
function aplicarFiltros() {
    const filtroBase = document.getElementById("filtroBase").value.toUpperCase();
    const filtroAlim = document.getElementById("filtroAlim").value.toUpperCase();
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");

    linhas.forEach(linha => {
        const base = (linha.children[6].innerText || "").toUpperCase();
        const alim = (linha.children[5].innerText || "").toUpperCase();

        const condBase = (filtroBase === "" || base === filtroBase);
        const condAlim = (filtroAlim === "" || alim === filtroAlim);

        linha.style.display = (condBase && condAlim) ? "" : "none";
    });

    atualizarBotoesSE();
}

// ------------------------------
// Atualizar alimentadores quando BASE muda
// ------------------------------
function atualizarAlimentadoresPorBase() {
    const baseSelecionada = document.getElementById("filtroBase").value;
    const selectAlim = document.getElementById("filtroAlim");

    const rows = Array.from(document.querySelectorAll("#tabelaDT tbody tr"));
    const alimentadores = new Set();

    rows.forEach(r => {
        const base = (r.children[6].innerText || "").trim();
        const alim = (r.children[5].innerText || "").trim();
        if (!baseSelecionada || base === baseSelecionada) {
            if (alim) alimentadores.add(alim);
        }
    });

    selectAlim.innerHTML = `<option value="">Mostrar Todos</option>`;
    Array.from(alimentadores).sort((a,b)=>a.localeCompare(b)).forEach(a => {
        selectAlim.innerHTML += `<option value="${a}">${a}</option>`;
    });
}

document.getElementById("filtroBase").addEventListener("change", function() {
    atualizarAlimentadoresPorBase();
    aplicarFiltros();
});

document.getElementById("filtroAlim").addEventListener("change", aplicarFiltros);

// ------------------------------
// ORDENAR TABELA
// ------------------------------
function isNumericString(s) {
    if (!s) return false;
    const cleaned = String(s).trim().replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,'');
    if (cleaned === "") return false;
    return !isNaN(Number(cleaned));
}

function ordenarTabela(coluna, thElement) {
    destacarTH(thElement);

    const tbody = document.querySelector("#tabelaDT tbody");
    const todas = Array.from(tbody.querySelectorAll("tr"));
    const visiveis = todas.filter(r => r.style.display !== "none");

    const sample = visiveis.map(r => r.children[coluna].innerText.trim()).filter(v => v !== "");
    const numericCount = sample.filter(v => isNumericString(v)).length;
    const isNumeric = sample.length > 0 && numericCount >= Math.ceil(sample.length * 0.6);

    let orderAsc;
    if (lastSortedCol === coluna) {
        orderAsc = !lastOrderAsc;
    } else {
        orderAsc = !isNumeric;
    }

    visiveis.sort((a,b) => {
        let va = a.children[coluna].innerText.trim();
        let vb = b.children[coluna].innerText.trim();

        if (isNumeric && isNumericString(va) && isNumericString(vb)) {
            const na = Number(va.replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,''))||0;
            const nb = Number(vb.replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,''))||0;
            return orderAsc ? na - nb : nb - na;
        }

        return orderAsc ? va.localeCompare(vb,'pt') : vb.localeCompare(va,'pt');
    });

    lastSortedCol = coluna;
    lastOrderAsc = orderAsc;

    visiveis.forEach(r => tbody.appendChild(r));
}

// ------------------------------
// GERAR MENSAGEM
// ------------------------------
function gerarMensagem(botao) {
    let linha = botao.parentNode.parentNode;
    let col = linha.getElementsByTagName("td");

    let codigoInput = col[10].querySelector("input");
    let codigo = codigoInput ? codigoInput.value.toUpperCase() : "";

    let obsInput = col[11].querySelector("input");
    let obs = obsInput ? obsInput.value : "";

    let msg =
`*MODELO PARA ATENDER DT*

*Ranking:* ${col[0].innerText}
*Tipo de equipamento:* ${col[1].innerText}
*Equipamento:* ${col[2].innerText}
*Reiteradas:* ${col[3].innerText}
*SE:* ${col[4].innerText}
*Alimentador:* ${col[5].innerText}
*Base:* ${col[6].innerText}
*CHI Total:* ${col[7].innerText}
*Data Ãºltima ocorrÃªncia:* ${col[8].innerText}
*EndereÃ§o:* ${col[9].innerText}
*DT / IncidÃªncia:* ${codigo}
*ObservaÃ§Ã£o:* ${obs}`;

    navigator.clipboard.writeText(msg);

    linha.classList.add("marcado");
    botao.classList.add("gerado");
    
    salvarSessaoAutomatica();
}

// ------------------------------
// CARREGAR XLSX
// ------------------------------
document.getElementById("arquivoXLSX").addEventListener("change", function(e) {
    let arquivo = e.target.files[0];
    let reader = new FileReader();

    reader.onload = function(event) {
        let data = new Uint8Array(event.target.result);
        let workbook = XLSX.read(data, {type: "array"});
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let json = XLSX.utils.sheet_to_json(sheet, {defval: ""});

        dadosOriginais = json;
        preencherTabela(json);
        salvarSessaoAutomatica();
    };

    reader.readAsArrayBuffer(arquivo);
});

// ------------------------------
// POPULAR TABELA
// ------------------------------
function preencherTabela(dados) {
    let tbody = document.querySelector("#tabelaDT tbody");
    tbody.innerHTML = "";

    dados.forEach(item => {
        let tr = document.createElement("tr");
        
        // Processa endereÃ§o para coordenadas
        let enderecoHTML = item.ENDEREÃ‡O || "";
        if (enderecoHTML && enderecoHTML.includes(",")) {
            let coords = enderecoHTML.split(",");
            if (coords.length === 2) {
                enderecoHTML = `<button onclick="window.open('https://www.google.com/maps?q=${coords[0].trim()},${coords[1].trim()}')">Mapa</button>`;
            }
        }

        tr.innerHTML = `
            <td>${item.RANKING || ""}</td>
            <td>${item["TIPO DE EQUIPAMENTO"] || ""}</td>
            <td>${item.EQUIPAMENTO || ""}</td>
            <td>${item["QNTD. REITERADA"] || ""}</td>
            <td>${item.SE || ""}</td>
            <td>${item.ALIMENTADOR || ""}</td>
            <td>${item.BASE || ""}</td>
            <td>${item["CHI TOTAL"] || ""}</td>
            <td>${formatarData(item["DT. ULTIMA OCORRÃŠNCIA"] || "")}</td>
            <td>${enderecoHTML}</td>
            <td><input maxlength="10" class="codigo" placeholder="Ex: INSERIR" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="obs" placeholder="Obs" oninput="salvarSessaoAutomatica()"></td>
            <td><button onclick="gerarMensagem(this)">Gerar Msg</button></td>
            <td><button class="reset-btn" onclick="resetarLinha(this)">â†º</button></td>
        `;

        tbody.appendChild(tr);
    });

    preencherFiltros();
    aplicarFiltros();
    atualizarBotoesSE();
}

// ------------------------------
// PREENCHER FILTROS
// ------------------------------
function preencherFiltros() {
    const rows = Array.from(document.querySelectorAll("#tabelaDT tbody tr"));
    let valoresBase = new Set();
    let valoresAlim = new Set();

    rows.forEach(r => {
        valoresBase.add(r.children[6].innerText.trim());
        valoresAlim.add(r.children[5].innerText.trim());
    });

    let selectBase = document.getElementById("filtroBase");
    const baseAtual = selectBase.value;
    selectBase.innerHTML = `<option value="">Mostrar Todas</option>`;
    Array.from(valoresBase).sort((a,b)=> (a||'').localeCompare(b||'')).forEach(base => {
        if (base) selectBase.innerHTML += `<option value="${base}">${base}</option>`;
    });
    selectBase.value = baseAtual;

    let selectAlim = document.getElementById("filtroAlim");
    const alimAtual = selectAlim.value;
    selectAlim.innerHTML = `<option value="">Mostrar Todos</option>`;
    Array.from(valoresAlim).sort((a,b)=> (a||'').localeCompare(b||'')).forEach(al => {
        if (al) selectAlim.innerHTML += `<option value="${al}">${al}</option>`;
    });
    selectAlim.value = alimAtual;
}

// ------------------------------
// ATUALIZAR BOTÃ•ES SE
// ------------------------------
function atualizarBotoesSE() {
    let botoesDiv = document.getElementById("botoesSE");
    botoesDiv.innerHTML = "<b>Filtrar por SE:</b><br>";

    let linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let contagem = {};

    linhas.forEach(l => {
        if (l.style.display !== "none") {
            let se = l.children[4].innerText.trim();
            if (se) contagem[se] = (contagem[se] || 0) + 1;
        }
    });

    Object.keys(contagem)
        .sort()
        .forEach(se => {
            let btn = document.createElement("button");
            btn.innerText = `${se} (${contagem[se]})`;
            btn.onclick = () => filtrarPorSE(se);
            botoesDiv.appendChild(btn);
        });
}

function filtrarPorSE(seSelecionado) {
    let linhas = document.querySelectorAll("#tabelaDT tbody tr");

    linhas.forEach(linha => {
        let se = linha.children[4].innerText.trim();
        linha.style.display = (se === seSelecionado) ? "" : "none";
    });

    atualizarBotoesSE();
}
</script>

</body>
</html>
